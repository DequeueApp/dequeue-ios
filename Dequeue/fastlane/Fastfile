default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    run_tests(
      project: "Dequeue.xcodeproj",
      scheme: "Dequeue",
      device: "iPhone 16",
      clean: true
    )
  end

  desc "Build for App Store"
  lane :build_appstore do
    setup_ci if ENV['CI']

    # Sync code signing certificates
    match(
      type: "appstore",
      readonly: is_ci,
      api_key: api_key
    )

    # Update project to use Match provisioning profiles
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Dequeue.xcodeproj",
      team_id: "9HE7YP99YB",
      code_sign_identity: "Apple Distribution",
      targets: "Dequeue",
      profile_name: ENV["sigh_com.ardonos.Dequeue_appstore_profile-name"],
      build_configurations: "Release"
    )

    # Increment build number based on TestFlight
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "Dequeue.xcodeproj"
    )

    # Build the app
    build_app(
      project: "Dequeue.xcodeproj",
      scheme: "Dequeue",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Dequeue.ipa"
    )
  end

  desc "Push a new build to TestFlight"
  lane :beta do
    build_appstore

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

  desc "Sync certificates for development"
  lane :sync_dev_certs do
    match(type: "development")
  end

  desc "Sync certificates for App Store"
  lane :sync_appstore_certs do
    match(type: "appstore")
  end

  # Helper to get App Store Connect API key
  private_lane :api_key do
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house: false
    )
  end
end
