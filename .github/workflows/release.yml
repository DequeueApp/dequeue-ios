name: Release to TestFlight

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: false

env:
  XCODE_VERSION: "26.2"

jobs:
  # Wait for version bump to complete if triggered by a regular push
  wait-for-version-bump:
    name: Wait for Version Bump
    runs-on: ubuntu-latest
    # Skip if this is the version bump commit itself, or if manually triggered
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Wait for version-bump workflow
        id: check
        run: |
          # Give version-bump workflow time to start and complete
          echo "Waiting for version-bump workflow to complete..."
          sleep 30
          echo "should_build=true" >> $GITHUB_OUTPUT

  build-ios:
    name: Build iOS
    runs-on: macos-15
    needs: wait-for-version-bump
    if: needs.wait-for-version-bump.outputs.should_build == 'true'

    steps:
      - name: Checkout (latest after version bump)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

      - name: Build Archive
        run: |
          # Archive without code signing - export step will handle signing
          xcodebuild archive \
            -project Dequeue/Dequeue.xcodeproj \
            -scheme Dequeue \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Dequeue-iOS.xcarchive \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      - name: Export IPA
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Dequeue-iOS.xcarchive \
            -exportPath $RUNNER_TEMP/export-ios \
            -exportOptionsPlist ci/ExportOptions-iOS.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 \
            -authenticationKeyID $APP_STORE_CONNECT_API_KEY_ID \
            -authenticationKeyIssuerID $APP_STORE_CONNECT_API_ISSUER_ID

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          xcrun notarytool store-credentials "AC_PASSWORD" \
            --key ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 \
            --key-id $APP_STORE_CONNECT_API_KEY_ID \
            --issuer $APP_STORE_CONNECT_API_ISSUER_ID

          xcrun altool --upload-app \
            --type ios \
            --file "$RUNNER_TEMP/export-ios/Dequeue.ipa" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

      - name: Upload dSYMs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dSYMs-iOS
          path: $RUNNER_TEMP/Dequeue-iOS.xcarchive/dSYMs
          retention-days: 30

  build-macos:
    name: Build macOS
    runs-on: macos-15
    needs: wait-for-version-bump
    if: needs.wait-for-version-bump.outputs.should_build == 'true'

    steps:
      - name: Checkout (latest after version bump)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

      - name: Build Archive
        run: |
          # Archive without code signing - export step will handle signing
          xcodebuild archive \
            -project Dequeue/Dequeue.xcodeproj \
            -scheme Dequeue \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Dequeue-macOS.xcarchive \
            -destination 'generic/platform=macOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      - name: Export App
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Dequeue-macOS.xcarchive \
            -exportPath $RUNNER_TEMP/export-macos \
            -exportOptionsPlist ci/ExportOptions-macOS.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 \
            -authenticationKeyID $APP_STORE_CONNECT_API_KEY_ID \
            -authenticationKeyIssuerID $APP_STORE_CONNECT_API_ISSUER_ID

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          # Find the .pkg or .app file
          EXPORT_FILE=$(find $RUNNER_TEMP/export-macos -name "*.pkg" -o -name "*.app" | head -1)

          if [[ "$EXPORT_FILE" == *.app ]]; then
            # If it's an .app, we need to create a .pkg for upload
            productbuild --component "$EXPORT_FILE" /Applications "$RUNNER_TEMP/export-macos/Dequeue.pkg"
            EXPORT_FILE="$RUNNER_TEMP/export-macos/Dequeue.pkg"
          fi

          xcrun altool --upload-app \
            --type macos \
            --file "$EXPORT_FILE" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

      - name: Upload dSYMs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dSYMs-macOS
          path: $RUNNER_TEMP/Dequeue-macOS.xcarchive/dSYMs
          retention-days: 30

  build-visionos:
    name: Build visionOS
    runs-on: macos-15
    needs: wait-for-version-bump
    # Temporarily disabled - visionOS code has platform compatibility issues
    if: false

    steps:
      - name: Checkout (latest after version bump)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          mkdir -p ~/.appstoreconnect/private_keys
          echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

      - name: Build Archive
        run: |
          # Archive without code signing - export step will handle signing
          xcodebuild archive \
            -project Dequeue/Dequeue.xcodeproj \
            -scheme Dequeue \
            -configuration Release \
            -archivePath $RUNNER_TEMP/Dequeue-visionOS.xcarchive \
            -destination 'generic/platform=visionOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO

      - name: Export IPA
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Dequeue-visionOS.xcarchive \
            -exportPath $RUNNER_TEMP/export-visionos \
            -exportOptionsPlist ci/ExportOptions-visionOS.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8 \
            -authenticationKeyID $APP_STORE_CONNECT_API_KEY_ID \
            -authenticationKeyIssuerID $APP_STORE_CONNECT_API_ISSUER_ID

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          xcrun altool --upload-app \
            --type ios \
            --file "$RUNNER_TEMP/export-visionos/Dequeue.ipa" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID"

      - name: Upload dSYMs artifact
        uses: actions/upload-artifact@v4
        with:
          name: dSYMs-visionOS
          path: $RUNNER_TEMP/Dequeue-visionOS.xcarchive/dSYMs
          retention-days: 30

  sentry-release:
    name: Create Sentry Release
    runs-on: ubuntu-latest
    needs: [build-ios, build-macos]
    if: always() && (needs.build-ios.result == 'success' || needs.build-macos.result == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download all dSYMs
        uses: actions/download-artifact@v4
        with:
          pattern: dSYMs-*
          path: ${{ runner.temp }}/dSYMs
          merge-multiple: true

      - name: Create Sentry Release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: dequeue-ios
        with:
          environment: production
          version: ${{ github.sha }}

      - name: Upload dSYMs to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
        run: |
          # Install sentry-cli
          curl -sL https://sentry.io/get-cli/ | bash

          # Upload dSYMs
          sentry-cli debug-files upload --org $SENTRY_ORG --project dequeue-ios ${{ runner.temp }}/dSYMs || true
